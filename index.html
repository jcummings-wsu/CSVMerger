<!DOCTYPE html>
<html>

<head>
	<title>CSVMerger</title>

	<!-- Stylesheets -->
	<link rel="stylesheet" href="./css/main.css" />
	<link rel="stylesheet" href="./node_modules/dragula/dist/dragula.css" </head>

	<body>
		<script src="./node_modules/dragula/dist/dragula.js"></script>
		<script>window.$ = window.jQuery = require('jquery');</script>

		<script>
			const { ipcRenderer } = require('electron');

			ipcRenderer.on('CreateSortable', (event) => {
				dragula([document.querySelector('#mergedcolumnlist')])
			});

			window.onload = function () {
				$(".fileBrowseBtn").click(function (event) {
					var app = require('electron').remote;
					var fs = require('fs'); // Load the File System to execute our common tasks (CRUD)
					var dialog = app.dialog;

					dialog.showOpenDialog(function (fileNames) {
						if (fileNames === undefined) {
							console.log("No file selected");
						} else {
							$(event.target).next('.filePathLabel').html(fileNames[0]);

							fs.readFile(fileNames[0], 'utf-8', function (err, data) {
								if (err) {
									alert("An error ocurred reading the file :" + err.message);
									return;
								}
								var lines = data.split(/[\r\n]+/);
								var headers = lines[0].split(',');

								var columnlist = $(event.target).closest('.pane').find('.columnlist');

								headers.forEach(element => {
									addColumn(columnlist, element)
								});
							});
						}

						// If all files have a values
						if ($('.filePathLabel').toArray().every(hasValue)) {
							MakeMergedColumns();
						}

					});

				});
			}

			function hasValue(val) {
				return (val.textContent.trim() != "");
			}
			function addColumn(list, column) {
				var col = `<div class="columnlist-item">
									<input type="checkbox" />` + column + `</div>`
				$(list).append(col);
			}
			function MakeMergedColumns() {
				alert($(".columnlist-item").length)
				$(".columnlist-item").each(function () {
					$("#mergedcolumnlist").append($(this).clone());
				});
			}


		</script>

		<div class="window">
			<div class="header">

			</div>

			<div class="window-content">
				<div class="pane-group">
					<div class="pane">
						<div class="pane-header">File 1</div>
						<div class="pane-section">
							<input class="fileBrowseBtn" type="button" value="Browse..." />
							<label class="filePathLabel" />
						</div>

						<div class="pane-section">
							<div id="columnlist1" class="columnlist">
							</div>
						</div>
					</div>

					<div class="pane">
						<div class="pane-header">File 2</div>
						<div class="pane-section">
							<input class="fileBrowseBtn" type="button" value="Browse..." />
							<label class="filePathLabel" />
						</div>

						<div class="pane-section">
							<div id="columnlist2" class="columnlist">
							</div>
						</div>
					</div>

					<div class="pane">
						<div class="pane-header">Merged</div>
						<div class="pane-section">
							<div id="mergedcolumnlist" class="mergedcolumnlist">
							</div>
						</div>
					</div>
				</div>
			</div>

			<div class="footer">
				<div>
					<h1>Options</h1>
				</div>
				<div class="options-pane-group">
					<div class="options-pane">
						<input type="checkbox" />Remove Duplicates
					</div>
					<div class="options-pane">
						<input type="button" value="Merge" />
					</div>
				</div>
			</div>
		</div>
	</body>

</html>